cmake_minimum_required(VERSION 3.8)
project(elu_robot_arm_framework)

# è®¾ç½®C++æ ‡å‡†
if(CMAKE_COMPILER_IS_GNUCXX OR CMAKE_CXX_COMPILER_ID MATCHES "Clang")
  add_compile_options(-Wall -Wextra -Wpedantic)
endif()

# è®¾ç½®C++17æ ‡å‡†ï¼ˆä¸ºäº†å…¼å®¹æœºæ¢°è‡‚SDKï¼‰
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_EXPORT_COMPILE_COMMANDS ON)

# é»˜è®¤æ„å»ºç±»å‹
if(NOT CMAKE_BUILD_TYPE)
    set(CMAKE_BUILD_TYPE Release CACHE STRING
        "The type of build, options are: Debug, Release, RelWithDebInfo, MinSizeRel." FORCE)
endif()

# æœºæ¢°è‡‚SDKç›¸å…³é€‰é¡¹
option(XCORE_LINK_SHARED_LIBS "Link shared library for xCore SDK" OFF)
option(XCORE_USE_XMATE_MODEL "Use xMateModel library for kinematics and dynamics" OFF)
option(BUILD_VISION_SUPPORT "Build vision communication support" ON)

# æŸ¥æ‰¾ROS2ä¾èµ–åŒ…
find_package(ament_cmake REQUIRED)
find_package(rclcpp REQUIRED)
find_package(rclpy REQUIRED)
find_package(std_msgs REQUIRED)
find_package(geometry_msgs REQUIRED)
find_package(sensor_msgs REQUIRED)
find_package(tf2 REQUIRED)
find_package(tf2_ros REQUIRED)
find_package(pluginlib REQUIRED)
find_package(std_srvs REQUIRED)
find_package(trajectory_msgs REQUIRED)
find_package(control_msgs QUIET)

# æŸ¥æ‰¾YAML-CPP
find_package(PkgConfig REQUIRED)
pkg_check_modules(YAML_CPP REQUIRED yaml-cpp)

# æŸ¥æ‰¾çº¿ç¨‹åº“ï¼ˆæœºæ¢°è‡‚SDKéœ€è¦ï¼‰
set(THREADS_PREFER_PTHREAD_FLAG ON)
find_package(Threads REQUIRED)

# æŸ¥æ‰¾æ¶ˆæ¯ç”ŸæˆåŒ…
find_package(rosidl_default_generators REQUIRED)

# ç”Ÿæˆæ¶ˆæ¯å’ŒæœåŠ¡
set(msg_files
  "msg/MotionCommand.msg"
  "msg/RobotStatus.msg"
  "msg/VisionResult.msg"
)

set(srv_files
  "srv/SwitchRobot.srv"
  "srv/ExecuteMotion.srv"
  "srv/TriggerVision.srv"
)

rosidl_generate_interfaces(${PROJECT_NAME}
  ${msg_files}
  ${srv_files}
  DEPENDENCIES std_msgs geometry_msgs sensor_msgs trajectory_msgs
)

# åŒ…å«ç›®å½•
include_directories(include)

# æ·»åŠ æœºæ¢°è‡‚SDKåŒ…å«ç›®å½•
set(SDK_INCLUDE_DIR ${CMAKE_CURRENT_SOURCE_DIR}/third_party/xcore_sdk/include)
if(EXISTS ${SDK_INCLUDE_DIR})
    include_directories(${SDK_INCLUDE_DIR})
    set(XCORE_SDK_FOUND TRUE)
    message(STATUS "Found XCore SDK headers at: ${SDK_INCLUDE_DIR}")
else()
    set(XCORE_SDK_FOUND FALSE)
    message(STATUS "XCore SDK headers not found - some features will be disabled")
endif()

# ROS2ä¾èµ–åˆ—è¡¨
set(dependencies
  rclcpp
  std_msgs
  geometry_msgs
  sensor_msgs
  tf2
  tf2_ros
  pluginlib 
  trajectory_msgs
  std_srvs
)

if(control_msgs_FOUND)
  list(APPEND dependencies control_msgs)
endif()

# ==================== æœºæ¢°è‡‚SDKåº“è®¾ç½® ====================

# åˆ›å»ºEigenæ¥å£åº“ï¼ˆæœºæ¢°è‡‚SDKä¾èµ–ï¼‰
add_library(eigen INTERFACE)
target_compile_definitions(eigen INTERFACE EIGEN_DONT_ALIGN_STATICALLY)
target_include_directories(eigen INTERFACE
    $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/third_party/eigen>)

# æœºæ¢°è‡‚SDKåº“è·¯å¾„è®¾ç½®
set(SDK_LIB_DIR ${CMAKE_CURRENT_SOURCE_DIR}/third_party/xcore_sdk/lib)

# åˆ›å»ºæœºæ¢°è‡‚SDKåº“ç›®æ ‡
if(EXISTS ${SDK_LIB_DIR} AND XCORE_SDK_FOUND)
    # å¯¼å…¥çš„æœºæ¢°è‡‚SDKåº“
    add_library(xcore_sdk_lib SHARED IMPORTED GLOBAL)
    add_library(xcore_sdk_static STATIC IMPORTED GLOBAL)
    
    if(WIN32)
        if(${CMAKE_SIZEOF_VOID_P} EQUAL 8)
            set(_ARCH_NAME "64bit")
        elseif(${CMAKE_SIZEOF_VOID_P} EQUAL 4)
            set(_ARCH_NAME "32bit")
        endif()
        
        set_target_properties(xcore_sdk_lib PROPERTIES
            IMPORTED_IMPLIB_RELEASE ${SDK_LIB_DIR}/Windows/Release/${_ARCH_NAME}/xCoreSDK.lib
            IMPORTED_LOCATION_RELEASE ${SDK_LIB_DIR}/Windows/Release/${_ARCH_NAME}/xCoreSDK.dll
            IMPORTED_IMPLIB_DEBUG ${SDK_LIB_DIR}/Windows/Debug/${_ARCH_NAME}/xCoreSDK.lib
            IMPORTED_LOCATION_DEBUG ${SDK_LIB_DIR}/Windows/Debug/${_ARCH_NAME}/xCoreSDK.dll
        )
        set_target_properties(xcore_sdk_static PROPERTIES
            IMPORTED_LOCATION_RELEASE ${SDK_LIB_DIR}/Windows/Release/${_ARCH_NAME}/xCoreSDK_static.lib
            IMPORTED_LOCATION_DEBUG ${SDK_LIB_DIR}/Windows/Debug/${_ARCH_NAME}/xCoreSDK_static.lib
        )
    elseif(UNIX)
        set(XCORESDK_LIBRARY_DIR ${SDK_LIB_DIR}/Linux/${CMAKE_SYSTEM_PROCESSOR})
        if(EXISTS ${XCORESDK_LIBRARY_DIR}/libxCoreSDK.so)
            set_target_properties(xcore_sdk_lib PROPERTIES
                IMPORTED_LOCATION ${XCORESDK_LIBRARY_DIR}/libxCoreSDK.so
            )
        endif()
        if(EXISTS ${XCORESDK_LIBRARY_DIR}/libxCoreSDK.a)
            set_target_properties(xcore_sdk_static PROPERTIES
                IMPORTED_LOCATION ${XCORESDK_LIBRARY_DIR}/libxCoreSDK.a
            )
        endif()
    endif()
    
    # åˆ›å»ºåˆ«åç”¨äºé“¾æ¥
    if(XCORE_LINK_SHARED_LIBS)
        add_library(XCoreSDK::XCoreSDK ALIAS xcore_sdk_lib)
    else()
        add_library(XCoreSDK::XCoreSDK ALIAS xcore_sdk_static)
    endif()
    
    set(XCORE_SDK_LIBRARY_FOUND TRUE)
    message(STATUS "XCore SDK libraries configured")
else()
    set(XCORE_SDK_LIBRARY_FOUND FALSE)
    message(STATUS "XCore SDK libraries not found - building without SDK support")
endif()

# xMateModelåº“æ”¯æŒï¼ˆå¯é€‰ï¼‰
if(XCORE_USE_XMATE_MODEL AND EXISTS ${SDK_LIB_DIR})
    add_library(xmatemodel_lib STATIC IMPORTED)
    
    if(WIN32)
        set_target_properties(xmatemodel_lib PROPERTIES
            IMPORTED_LOCATION_RELEASE ${SDK_LIB_DIR}/Windows/Release/64bit/xMateModel.lib
            IMPORTED_LOCATION_DEBUG ${SDK_LIB_DIR}/Windows/Debug/64bit/xMateModeld.lib)
    elseif(UNIX AND ${CMAKE_SYSTEM_PROCESSOR} STREQUAL "x86_64")
        set_target_properties(xmatemodel_lib PROPERTIES
            IMPORTED_LOCATION ${SDK_LIB_DIR}/Linux/x86_64/libxMateModel.a)
    endif()
    
    set(XMATEMODEL_AVAILABLE TRUE)
else()
    set(XMATEMODEL_AVAILABLE FALSE)
endif()

# ==================== æ„å»ºROS2æ¡†æ¶åº“ ====================

# æ„å»ºæ ¸å¿ƒåº“
add_library(${PROJECT_NAME}_core SHARED
  src/controllers/motion_controller.cpp
  src/utils/plugin_manager.cpp
  src/safety/safety_checker.cpp
)

target_include_directories(${PROJECT_NAME}_core PUBLIC
  $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/include>
  $<INSTALL_INTERFACE:include>
  ${YAML_CPP_INCLUDE_DIRS}
)

target_link_libraries(${PROJECT_NAME}_core 
  ${YAML_CPP_LIBRARIES}
  Threads::Threads
)

# å¦‚æœæœºæ¢°è‡‚SDKå¯ç”¨ï¼Œé“¾æ¥SDKåº“
if(XCORE_SDK_LIBRARY_FOUND)
    target_link_libraries(${PROJECT_NAME}_core XCoreSDK::XCoreSDK eigen)
    target_compile_definitions(${PROJECT_NAME}_core PUBLIC 
        XCORE_SDK_AVAILABLE
        $<$<BOOL:${XCORE_LINK_SHARED_LIBS}>:XCORESDK_DLL>
        $<$<CXX_COMPILER_ID:MSVC>:_USE_MATH_DEFINES>
    )
    
    if(XMATEMODEL_AVAILABLE)
        target_link_libraries(${PROJECT_NAME}_core xmatemodel_lib)
        target_compile_definitions(${PROJECT_NAME}_core PUBLIC XMATEMODEL_LIB_SUPPORTED)
    endif()
endif()

target_compile_options(${PROJECT_NAME}_core PUBLIC ${YAML_CPP_CFLAGS_OTHER})
ament_target_dependencies(${PROJECT_NAME}_core ${dependencies})

# ç­‰å¾…æ¶ˆæ¯ç”Ÿæˆå®Œæˆ
rosidl_get_typesupport_target(cpp_typesupport_target ${PROJECT_NAME} "rosidl_typesupport_cpp")
target_link_libraries(${PROJECT_NAME}_core "${cpp_typesupport_target}")

# ==================== æ„å»ºRokaeé€‚é…å™¨ ====================

# æ£€æŸ¥rokae_adapter.cppæ˜¯å¦å­˜åœ¨
if(EXISTS ${CMAKE_CURRENT_SOURCE_DIR}/src/adapters/rokae_adapter.cpp)
    add_library(rokae_adapter SHARED
      src/adapters/rokae_adapter.cpp
    )
    
    target_include_directories(rokae_adapter PUBLIC
      $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/include>
      $<INSTALL_INTERFACE:include>
    )
    
    target_link_libraries(rokae_adapter ${PROJECT_NAME}_core)
    
    if(XCORE_SDK_LIBRARY_FOUND)
        target_link_libraries(rokae_adapter XCoreSDK::XCoreSDK eigen)
    endif()
    
    ament_target_dependencies(rokae_adapter ${dependencies})
    set(ROKAE_ADAPTER_AVAILABLE TRUE)
    message(STATUS "RokaeAdapter library will be built")
else()
    set(ROKAE_ADAPTER_AVAILABLE FALSE)
    message(STATUS "RokaeAdapter library will NOT be built - source file missing")
    message(STATUS "Expected location: src/adapters/rokae_adapter.cpp")
endif()

# ==================== æ„å»ºRokaeMotionPlanneråº“ ====================

# æ£€æŸ¥æ˜¯å¦å­˜åœ¨RokaeMotionPlanneræºæ–‡ä»¶
set(ROKAE_MOTION_PLANNER_SRC "")

if(EXISTS ${CMAKE_CURRENT_SOURCE_DIR}/src/planners/rokae_motion_planner.cpp)
    set(ROKAE_MOTION_PLANNER_SRC src/planners/rokae_motion_planner.cpp)
    message(STATUS "Found RokaeMotionPlanner at: src/planners/rokae_motion_planner.cpp")
elseif(EXISTS ${CMAKE_CURRENT_SOURCE_DIR}/src/motion_planner/rokae_motion_planner.cpp)
    set(ROKAE_MOTION_PLANNER_SRC src/motion_planner/rokae_motion_planner.cpp)
    message(STATUS "Found RokaeMotionPlanner at: src/motion_planner/rokae_motion_planner.cpp")
else()
    message(STATUS "RokaeMotionPlanner source file not found")
    message(STATUS "Checked paths:")
    message(STATUS "  - src/planners/rokae_motion_planner.cpp")
    message(STATUS "  - src/motion_planner/rokae_motion_planner.cpp")
endif()

# åªæœ‰åœ¨æ‰¾åˆ°æºæ–‡ä»¶æ—¶æ‰åˆ›å»ºåº“
if(NOT ROKAE_MOTION_PLANNER_SRC STREQUAL "")
    add_library(rokae_motion_planner SHARED
      ${ROKAE_MOTION_PLANNER_SRC}
    )
    
    target_include_directories(rokae_motion_planner PUBLIC
      $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/include>
      $<INSTALL_INTERFACE:include>
    )
    
    target_link_libraries(rokae_motion_planner ${PROJECT_NAME}_core)
    
    if(ROKAE_ADAPTER_AVAILABLE)
        target_link_libraries(rokae_motion_planner rokae_adapter)
    endif()
    
    if(XCORE_SDK_LIBRARY_FOUND)
        target_link_libraries(rokae_motion_planner XCoreSDK::XCoreSDK eigen)
    endif()
    
    ament_target_dependencies(rokae_motion_planner ${dependencies})
    set(ROKAE_MOTION_PLANNER_AVAILABLE TRUE)
    message(STATUS "RokaeMotionPlanner library will be built")
else()
    set(ROKAE_MOTION_PLANNER_AVAILABLE FALSE)
    message(STATUS "RokaeMotionPlanner library will NOT be built - source file missing")
endif()

# ==================== æ„å»ºè§†è§‰é€šä¿¡æ¨¡å— ====================

if(BUILD_VISION_SUPPORT)
    # æ£€æŸ¥è§†è§‰é€šä¿¡æºæ–‡ä»¶æ˜¯å¦å­˜åœ¨
    set(VISION_COMM_SOURCES "")
    
    if(EXISTS ${CMAKE_CURRENT_SOURCE_DIR}/src/vision/vision_communication.cpp)
        list(APPEND VISION_COMM_SOURCES src/vision/vision_communication.cpp)
        message(STATUS "Found VisionCommunication at: src/vision/vision_communication.cpp")
    elseif(EXISTS ${CMAKE_CURRENT_SOURCE_DIR}/src/communication/vision_communication.cpp)
        list(APPEND VISION_COMM_SOURCES src/communication/vision_communication.cpp)
        message(STATUS "Found VisionCommunication at: src/communication/vision_communication.cpp")
    else()
        message(STATUS "VisionCommunication source file not found")
        message(STATUS "Checked paths:")
        message(STATUS "  - src/vision/vision_communication.cpp")
        message(STATUS "  - src/communication/vision_communication.cpp")
    endif()
    
    if(NOT VISION_COMM_SOURCES STREQUAL "")
        # æ„å»ºè§†è§‰é€šä¿¡åº“
        add_library(vision_communication SHARED
          ${VISION_COMM_SOURCES}
        )
        
        target_include_directories(vision_communication PUBLIC
          $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/include>
          $<INSTALL_INTERFACE:include>
        )
        
        target_link_libraries(vision_communication ${PROJECT_NAME}_core)
        
        # å¦‚æœRokaeé€‚é…å™¨å¯ç”¨ï¼Œé“¾æ¥å®ƒ
        if(ROKAE_ADAPTER_AVAILABLE)
            target_link_libraries(vision_communication rokae_adapter)
        endif()
        
        # ç½‘ç»œåº“æ”¯æŒ
        if(WIN32)
            target_link_libraries(vision_communication ws2_32)
            target_compile_definitions(vision_communication PRIVATE
                WIN32_LEAN_AND_MEAN
                _WIN32_WINNT=0x0601  # Windows 7+
            )
        else()
            # Linuxä¸‹å¯èƒ½éœ€è¦çš„ç½‘ç»œåº“
            find_package(PkgConfig QUIET)
            if(PkgConfig_FOUND)
                pkg_check_modules(LIBUDEV libudev)
                if(LIBUDEV_FOUND)
                    target_link_libraries(vision_communication ${LIBUDEV_LIBRARIES})
                    target_include_directories(vision_communication PRIVATE ${LIBUDEV_INCLUDE_DIRS})
                endif()
            endif()
        endif()
        
        ament_target_dependencies(vision_communication ${dependencies})
        set(VISION_COMMUNICATION_AVAILABLE TRUE)
        message(STATUS "VisionCommunication library will be built")
    else()
        set(VISION_COMMUNICATION_AVAILABLE FALSE)
        message(STATUS "VisionCommunication library will NOT be built - source file missing")
    endif()
else()
    set(VISION_COMMUNICATION_AVAILABLE FALSE)
    message(STATUS "Vision communication support disabled by BUILD_VISION_SUPPORT=OFF")
endif()

# ==================== æ„å»ºé€‚é…å™¨æ’ä»¶ ====================

# ELUé€‚é…å™¨æ’ä»¶
if(EXISTS ${CMAKE_CURRENT_SOURCE_DIR}/plugins/elu_adapter/src/elu_adapter.cpp)
    add_library(elu_adapter SHARED
      plugins/elu_adapter/src/elu_adapter.cpp
    )
    
    target_include_directories(elu_adapter PUBLIC
      $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/plugins/elu_adapter/include>
      $<INSTALL_INTERFACE:include>
    )
    
    target_link_libraries(elu_adapter ${PROJECT_NAME}_core)
    ament_target_dependencies(elu_adapter ${dependencies})
    set(ELU_ADAPTER_AVAILABLE TRUE)
else()
    set(ELU_ADAPTER_AVAILABLE FALSE)
endif()

# ==================== æ„å»ºèŠ‚ç‚¹å¯æ‰§è¡Œæ–‡ä»¶ ====================

# motion_controller_node  
if(EXISTS ${CMAKE_CURRENT_SOURCE_DIR}/src/nodes/motion_controller_node.cpp)
    add_executable(motion_controller_node src/nodes/motion_controller_node.cpp)
    target_link_libraries(motion_controller_node ${PROJECT_NAME}_core)
    ament_target_dependencies(motion_controller_node ${dependencies})
    set(MOTION_CONTROLLER_NODE_AVAILABLE TRUE)
else()
    set(MOTION_CONTROLLER_NODE_AVAILABLE FALSE)
endif()

# status_monitor_node
if(EXISTS ${CMAKE_CURRENT_SOURCE_DIR}/src/nodes/status_monitor_node.cpp)
    add_executable(status_monitor_node src/nodes/status_monitor_node.cpp)
    target_link_libraries(status_monitor_node ${PROJECT_NAME}_core)
    ament_target_dependencies(status_monitor_node ${dependencies})
    set(STATUS_MONITOR_NODE_AVAILABLE TRUE)
else()
    set(STATUS_MONITOR_NODE_AVAILABLE FALSE)
endif()

# rokae_integration_example
if(EXISTS ${CMAKE_CURRENT_SOURCE_DIR}/src/nodes/rokae_integration_example.cpp)
    add_executable(rokae_integration_example src/nodes/rokae_integration_example.cpp)
    
    # é“¾æ¥æ‰€æœ‰å¿…è¦çš„åº“ï¼ˆæŒ‰æ­£ç¡®é¡ºåºï¼‰
    target_link_libraries(rokae_integration_example ${PROJECT_NAME}_core)
    
    # æ¡ä»¶é“¾æ¥å¯é€‰åº“
    if(ROKAE_MOTION_PLANNER_AVAILABLE)
        target_link_libraries(rokae_integration_example rokae_motion_planner)
    endif()
    
    if(ROKAE_ADAPTER_AVAILABLE)
        target_link_libraries(rokae_integration_example rokae_adapter)
    endif()
    
    # å¦‚æœSDKå¯ç”¨ï¼Œç›´æ¥é“¾æ¥SDK
    if(XCORE_SDK_LIBRARY_FOUND)
        target_link_libraries(rokae_integration_example XCoreSDK::XCoreSDK eigen)
    endif()
    
    ament_target_dependencies(rokae_integration_example ${dependencies})
    set(ROKAE_INTEGRATION_EXAMPLE_AVAILABLE TRUE)
else()
    set(ROKAE_INTEGRATION_EXAMPLE_AVAILABLE FALSE)
endif()

# ==================== è§†è§‰é€šä¿¡èŠ‚ç‚¹ ====================

# ç‹¬ç«‹çš„è§†è§‰é€šä¿¡èŠ‚ç‚¹
if(VISION_COMMUNICATION_AVAILABLE AND EXISTS ${CMAKE_CURRENT_SOURCE_DIR}/src/nodes/vision_communication_node.cpp)
    add_executable(vision_communication_node 
      src/nodes/vision_communication_node.cpp
    )
    
    target_link_libraries(vision_communication_node 
      ${PROJECT_NAME}_core
      vision_communication
    )
    
    if(ROKAE_ADAPTER_AVAILABLE)
        target_link_libraries(vision_communication_node rokae_adapter)
    endif()
    
    # Windowsç½‘ç»œåº“æ”¯æŒ
    if(WIN32)
        target_link_libraries(vision_communication_node ws2_32)
    endif()
    
    ament_target_dependencies(vision_communication_node ${dependencies})
    set(VISION_COMMUNICATION_NODE_AVAILABLE TRUE)
else()
    set(VISION_COMMUNICATION_NODE_AVAILABLE FALSE)
endif()

# è§†è§‰é›†æˆç¤ºä¾‹èŠ‚ç‚¹
if(EXISTS ${CMAKE_CURRENT_SOURCE_DIR}/src/nodes/vision_integration_example.cpp)
    add_executable(vision_integration_example 
      src/nodes/vision_integration_example.cpp
    )
    
    target_link_libraries(vision_integration_example ${PROJECT_NAME}_core)
    
    # æ¡ä»¶é“¾æ¥å¯é€‰åº“
    if(VISION_COMMUNICATION_AVAILABLE)
        target_link_libraries(vision_integration_example vision_communication)
    endif()
    
    if(ROKAE_ADAPTER_AVAILABLE)
        target_link_libraries(vision_integration_example rokae_adapter)
    endif()
    
    if(ROKAE_MOTION_PLANNER_AVAILABLE)
        target_link_libraries(vision_integration_example rokae_motion_planner)
    endif()
    
    # Windowsç½‘ç»œåº“æ”¯æŒ
    if(WIN32)
        target_link_libraries(vision_integration_example ws2_32)
    endif()
    
    ament_target_dependencies(vision_integration_example ${dependencies})
    set(VISION_INTEGRATION_EXAMPLE_AVAILABLE TRUE)
else()
    set(VISION_INTEGRATION_EXAMPLE_AVAILABLE FALSE)
endif()

# ==================== å®‰è£…é…ç½® ====================

# æ”¶é›†æ‰€æœ‰åº“ç›®æ ‡
set(INSTALL_TARGETS ${PROJECT_NAME}_core)

if(ROKAE_ADAPTER_AVAILABLE)
    list(APPEND INSTALL_TARGETS rokae_adapter)
endif()

if(ROKAE_MOTION_PLANNER_AVAILABLE)
    list(APPEND INSTALL_TARGETS rokae_motion_planner)
endif()

if(VISION_COMMUNICATION_AVAILABLE)
    list(APPEND INSTALL_TARGETS vision_communication)
endif()

if(ELU_ADAPTER_AVAILABLE)
    list(APPEND INSTALL_TARGETS elu_adapter)
endif()

# å®‰è£…åº“å’Œæ’ä»¶
install(TARGETS ${INSTALL_TARGETS}
  EXPORT export_${PROJECT_NAME}
  ARCHIVE DESTINATION lib
  LIBRARY DESTINATION lib
  RUNTIME DESTINATION bin
)

# æ”¶é›†æ‰€æœ‰å¯æ‰§è¡Œæ–‡ä»¶ç›®æ ‡
set(EXECUTABLE_TARGETS)

if(ROKAE_INTEGRATION_EXAMPLE_AVAILABLE)
    list(APPEND EXECUTABLE_TARGETS rokae_integration_example)
endif()

if(MOTION_CONTROLLER_NODE_AVAILABLE)
    list(APPEND EXECUTABLE_TARGETS motion_controller_node)
endif()

if(STATUS_MONITOR_NODE_AVAILABLE)
    list(APPEND EXECUTABLE_TARGETS status_monitor_node)
endif()

if(VISION_COMMUNICATION_NODE_AVAILABLE)
    list(APPEND EXECUTABLE_TARGETS vision_communication_node)
endif()

if(VISION_INTEGRATION_EXAMPLE_AVAILABLE)
    list(APPEND EXECUTABLE_TARGETS vision_integration_example)
endif()

# å®‰è£…å¯æ‰§è¡Œæ–‡ä»¶
if(EXECUTABLE_TARGETS)
    install(TARGETS ${EXECUTABLE_TARGETS}
      DESTINATION lib/${PROJECT_NAME}
    )
endif()

# å®‰è£…å¤´æ–‡ä»¶
install(DIRECTORY include/
  DESTINATION include/
)

if(EXISTS ${CMAKE_CURRENT_SOURCE_DIR}/plugins/elu_adapter/include/)
    install(DIRECTORY plugins/elu_adapter/include/
      DESTINATION include/
    )
endif()

if(EXISTS ${CMAKE_CURRENT_SOURCE_DIR}/plugins/rokae_adapter/include/)
    install(DIRECTORY plugins/rokae_adapter/include/
      DESTINATION include/
    )
endif()

# å®‰è£…é…ç½®å’Œå¯åŠ¨æ–‡ä»¶
if(EXISTS ${CMAKE_CURRENT_SOURCE_DIR}/launch)
    install(DIRECTORY launch
      DESTINATION share/${PROJECT_NAME}/
    )
endif()

if(EXISTS ${CMAKE_CURRENT_SOURCE_DIR}/config)
    install(DIRECTORY config
      DESTINATION share/${PROJECT_NAME}/
    )
endif()

# å¯¼å‡ºæ’ä»¶ï¼ˆå¦‚æœæ’ä»¶æ–‡ä»¶å­˜åœ¨ï¼‰
if(ELU_ADAPTER_AVAILABLE AND EXISTS ${CMAKE_CURRENT_SOURCE_DIR}/plugins/elu_adapter/elu_adapter_plugins.xml)
    pluginlib_export_plugin_description_file(${PROJECT_NAME} plugins/elu_adapter/elu_adapter_plugins.xml)
endif()

if(ROKAE_ADAPTER_AVAILABLE AND EXISTS ${CMAKE_CURRENT_SOURCE_DIR}/plugins/rokae_adapter/rokae_adapter_plugins.xml)
    pluginlib_export_plugin_description_file(${PROJECT_NAME} plugins/rokae_adapter/rokae_adapter_plugins.xml)
endif()

# å¯¼å‡ºç›®æ ‡å’Œä¾èµ–
ament_export_targets(export_${PROJECT_NAME} HAS_LIBRARY_TARGET)
ament_export_dependencies(${dependencies})

# ==================== æµ‹è¯•é…ç½® ====================

if(BUILD_TESTING)
  find_package(ament_lint_auto REQUIRED)
  ament_lint_auto_find_test_dependencies()
  
  # åªæœ‰åœ¨æœ‰gtestçš„æƒ…å†µä¸‹æ‰æ·»åŠ æµ‹è¯•
  find_package(ament_cmake_gtest QUIET)
  if(ament_cmake_gtest_FOUND)
    # æ ¸å¿ƒåº“æµ‹è¯•
    if(EXISTS ${CMAKE_CURRENT_SOURCE_DIR}/test/unit/test_plugin_manager.cpp)
        ament_add_gtest(test_plugin_manager test/unit/test_plugin_manager.cpp)
        target_link_libraries(test_plugin_manager ${PROJECT_NAME}_core)
        ament_target_dependencies(test_plugin_manager ${dependencies})
    endif()
    
    if(EXISTS ${CMAKE_CURRENT_SOURCE_DIR}/test/unit/test_safety_checker.cpp)
        ament_add_gtest(test_safety_checker test/unit/test_safety_checker.cpp)
        target_link_libraries(test_safety_checker ${PROJECT_NAME}_core)
        ament_target_dependencies(test_safety_checker ${dependencies})
    endif()
    
    # å¦‚æœæœºæ¢°è‡‚SDKå¯ç”¨ï¼Œæ·»åŠ SDKç›¸å…³æµ‹è¯•
    if(XCORE_SDK_LIBRARY_FOUND AND EXISTS ${CMAKE_CURRENT_SOURCE_DIR}/test/unit/test_rokae_adapter.cpp)
        ament_add_gtest(test_rokae_adapter test/unit/test_rokae_adapter.cpp)
        target_link_libraries(test_rokae_adapter ${PROJECT_NAME}_core XCoreSDK::XCoreSDK eigen)
        ament_target_dependencies(test_rokae_adapter ${dependencies})
    endif()
    
    # è§†è§‰é€šä¿¡æ¨¡å—æµ‹è¯•
    if(VISION_COMMUNICATION_AVAILABLE AND EXISTS ${CMAKE_CURRENT_SOURCE_DIR}/test/unit/test_vision_communication.cpp)
        ament_add_gtest(test_vision_communication 
          test/unit/test_vision_communication.cpp
        )
        target_link_libraries(test_vision_communication 
          ${PROJECT_NAME}_core 
          vision_communication
        )
        if(WIN32)
            target_link_libraries(test_vision_communication ws2_32)
        endif()
        ament_target_dependencies(test_vision_communication ${dependencies})
    endif()
    
    # TCPé€šä¿¡é›†æˆæµ‹è¯•
    if(VISION_COMMUNICATION_AVAILABLE AND EXISTS ${CMAKE_CURRENT_SOURCE_DIR}/test/integration/test_tcp_communication.cpp)
        ament_add_gtest(test_tcp_communication 
          test/integration/test_tcp_communication.cpp
        )
        target_link_libraries(test_tcp_communication 
          ${PROJECT_NAME}_core 
          vision_communication
        )
        if(WIN32)
            target_link_libraries(test_tcp_communication ws2_32)
        endif()
        ament_target_dependencies(test_tcp_communication ${dependencies})
    endif()
  endif()
endif()

# ==================== æ„å»ºçŠ¶æ€æŠ¥å‘Š ====================

# åœ¨æ„å»ºç»“æŸæ—¶è¾“å‡ºçŠ¶æ€æŠ¥å‘Š
message(STATUS "")
message(STATUS "=== ELU Robot Arm Framework Build Configuration ===")
message(STATUS "Build Type: ${CMAKE_BUILD_TYPE}")
message(STATUS "C++ Standard: ${CMAKE_CXX_STANDARD}")
message(STATUS "")
message(STATUS "SDK Support:")
message(STATUS "  XCore SDK Found: ${XCORE_SDK_FOUND}")
message(STATUS "  XCore SDK Library Found: ${XCORE_SDK_LIBRARY_FOUND}")
message(STATUS "  xMateModel Available: ${XMATEMODEL_AVAILABLE}")
message(STATUS "")
message(STATUS "Core Libraries:")
message(STATUS "  Rokae Adapter: ${ROKAE_ADAPTER_AVAILABLE}")
message(STATUS "  Rokae Motion Planner: ${ROKAE_MOTION_PLANNER_AVAILABLE}")
message(STATUS "  Vision Communication: ${VISION_COMMUNICATION_AVAILABLE}")
message(STATUS "  ELU Adapter: ${ELU_ADAPTER_AVAILABLE}")
message(STATUS "")
message(STATUS "Executable Nodes:")
message(STATUS "  Rokae Integration Example: ${ROKAE_INTEGRATION_EXAMPLE_AVAILABLE}")
message(STATUS "  Vision Communication Node: ${VISION_COMMUNICATION_NODE_AVAILABLE}")
message(STATUS "  Vision Integration Example: ${VISION_INTEGRATION_EXAMPLE_AVAILABLE}")
message(STATUS "  Motion Controller Node: ${MOTION_CONTROLLER_NODE_AVAILABLE}")
message(STATUS "  Status Monitor Node: ${STATUS_MONITOR_NODE_AVAILABLE}")
message(STATUS "")
message(STATUS "Install Targets: ${INSTALL_TARGETS}")
message(STATUS "Executable Targets: ${EXECUTABLE_TARGETS}")
message(STATUS "")
message(STATUS "Build Options:")
message(STATUS "  XCORE_LINK_SHARED_LIBS: ${XCORE_LINK_SHARED_LIBS}")
message(STATUS "  XCORE_USE_XMATE_MODEL: ${XCORE_USE_XMATE_MODEL}")
message(STATUS "  BUILD_VISION_SUPPORT: ${BUILD_VISION_SUPPORT}")
message(STATUS "  BUILD_TESTING: ${BUILD_TESTING}")
message(STATUS "==================================================")
message(STATUS "")

# ç»™å‡ºæ„å»ºå»ºè®®
if(NOT XCORE_SDK_LIBRARY_FOUND)
    message(STATUS "ğŸ’¡ Build Tips:")
    message(STATUS "   To enable full Rokae robot support, place the xCore SDK at:")
    message(STATUS "   ${CMAKE_CURRENT_SOURCE_DIR}/third_party/xcore_sdk/")
    message(STATUS "")
endif()

if(NOT VISION_COMMUNICATION_AVAILABLE AND BUILD_VISION_SUPPORT)
    message(STATUS "ğŸ’¡ Vision Support Tips:")
    message(STATUS "   To enable vision communication, create the source file at:")
    message(STATUS "   ${CMAKE_CURRENT_SOURCE_DIR}/src/vision/vision_communication.cpp")
    message(STATUS "")
endif()

ament_package()